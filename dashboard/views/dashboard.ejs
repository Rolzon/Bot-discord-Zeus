<%- include('layout', { title: 'Dashboard - Zeus System', body: `
<div class="mb-3"></div>

${typeof error !== 'undefined' && error ? `
<div class="alert alert-warning" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    ${error}
</div>
` : ''}

<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-number">${guilds.length}</div>
            <div class="stats-label">
                <i class="fas fa-crown me-1"></i>
                Servidores Administrados
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-number">${botGuilds}</div>
            <div class="stats-label">
                <i class="fas fa-server me-1"></i>
                Servidores Totales del Bot
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-number" id="onlineUsers">-</div>
            <div class="stats-label">
                <i class="fas fa-users me-1"></i>
                Usuarios Online
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-number" id="botUptime">-</div>
            <div class="stats-label">
                <i class="fas fa-clock me-1"></i>
                Tiempo Activo
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-server me-2"></i>
            Tus Servidores
        </h5>
    </div>
    <div class="card-body">
        ${guilds.length === 0 ? `
            <div class="text-center py-5">
                <i class="fas fa-robot fa-4x text-muted mb-3"></i>
                <h4>No hay servidores disponibles</h4>
                <p class="text-muted mb-4">
                    Para usar el dashboard, necesitas:
                </p>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success me-2"></i>Tener permisos de administrador en un servidor</li>
                    <li><i class="fas fa-check text-success me-2"></i>Que el bot esté en ese servidor</li>
                    <li><i class="fas fa-check text-success me-2"></i>Invitar el bot si no está presente</li>
                </ul>
                <a href="https://discord.com/api/oauth2/authorize?client_id=${process.env.CLIENT_ID}&permissions=8&scope=bot%20applications.commands" 
                   class="btn btn-primary" target="_blank">
                    <i class="fas fa-plus me-2"></i>Invitar Bot a Servidor
                </a>
            </div>
        ` : `
            <div class="row g-4">
                ${guilds.map(guild => `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 guild-card" data-guild-id="${guild.id}">
                            <div class="card-body text-center">
                                <img src="${guild.icon ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png?size=128` : '/images/default-guild.png'}" 
                                     alt="${guild.name}" class="guild-icon mb-3">
                                <h6 class="card-title">${guild.name}</h6>
                                <p class="text-muted small mb-3">
                                    <i class="fas fa-users me-1"></i>
                                    <span class="member-count" data-guild-id="${guild.id}">Cargando...</span> miembros
                                </p>
                                <div class="d-grid gap-2">
                                    <a href="/guild/${guild.id}" class="btn btn-primary">
                                        <i class="fas fa-cog me-2"></i>Administrar
                                    </a>
                                    <a href="/tickets/${guild.id}" class="btn btn-outline-primary">
                                        <i class="fas fa-ticket-alt me-2"></i>Tickets
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `}
    </div>
</div>

<div class="row mt-4 dashboard-equal-row">
    <div class="col-md-6 d-flex">
        <div class="card dashboard-equal-card flex-fill">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Actividad Reciente
                </h6>
            </div>
            <div class="card-body">
                <div id="activityChart" style="height: 300px;">
                    <canvas id="activityCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 d-flex">
        <div class="card dashboard-equal-card flex-fill">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bell me-2"></i>
                    Notificaciones Recientes
                </h6>
            </div>
            <div class="card-body">
                <div id="recentNotifications">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-info"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="fw-bold">Bot conectado</div>
                            <small class="text-muted">El bot se conectó exitosamente</small>
                        </div>
                        <small class="text-muted">Ahora</small>
                    </div>
                    
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <i class="fas fa-server text-success"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="fw-bold">Dashboard iniciado</div>
                            <small class="text-muted">Panel web disponible</small>
                        </div>
                        <small class="text-muted">Hace 1 min</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .guild-card {
        transition: all 0.3s ease;
        cursor: pointer;
        background: var(--bg-card);
    }
    
    .guild-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-xl);
    }
    
    .guild-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .stats-card {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white !important;
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
    }
    
    .stats-number {
        font-size: 2rem;
        font-weight: bold;
        color: white !important;
    }
    
    .stats-label {
        color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .dashboard-equal-row > [class*="col-"] {
        padding-left: 0;
        padding-right: 0;
    }
    
    .dashboard-equal-card {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
</style>
`, script: `
<script>
    // Load guild member counts
    async function loadGuildStats() {
        const guildCards = document.querySelectorAll('[data-guild-id]');
        
        for (const card of guildCards) {
            const guildId = card.dataset.guildId;
            const memberCountElement = document.querySelector('.member-count[data-guild-id="' + guildId + '"]');
            
            try {
                const response = await fetch('/api/guild/' + guildId + '/info');
                if (response.ok) {
                    const data = await response.json();
                    if (memberCountElement) {
                        memberCountElement.textContent = data.memberCount.toLocaleString();
                    }
                }
            } catch (error) {
                console.error('Error loading guild stats:', error);
                if (memberCountElement) {
                    memberCountElement.textContent = 'Error';
                }
            }
        }
    }

    // Load bot statistics
    async function loadBotStats() {
        try {
            // This would connect to a general bot stats endpoint
            const uptime = Math.floor(Math.random() * 86400); // Placeholder
            document.getElementById('botUptime').textContent = formatUptime(uptime);
            
            // Simulate online users (would come from actual bot stats)
            document.getElementById('onlineUsers').textContent = Math.floor(Math.random() * 1000) + 500;
        } catch (error) {
            console.error('Error loading bot stats:', error);
        }
    }

    // Create activity chart
    function createActivityChart() {
        const ctx = document.getElementById('activityCanvas').getContext('2d');
        
        // Sample data - would come from actual bot analytics
        const data = {
            labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
            datasets: [{
                label: 'Comandos Ejecutados',
                data: [12, 19, 3, 5, 2, 3, 9],
                borderColor: '#5865f2',
                backgroundColor: 'rgba(88, 101, 242, 0.1)',
                tension: 0.4
            }]
        };

        new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        loadGuildStats();
        loadBotStats();
        createActivityChart();
    });

    // Refresh data function
    function refreshData() {
        loadGuildStats();
        loadBotStats();
    }
</script>
` }) %>
