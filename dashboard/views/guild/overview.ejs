<%- include('../layout', { title: 'Panel de Control - ' + guild.name, body: `
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">
            <img src="${guild.iconURL() || '/images/default-guild.png'}" alt="${guild.name}" class="guild-icon me-3">
            ${guild.name}
        </h1>
        <p class="text-muted mb-0">Panel de administración completo</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="refreshData()">
            <i class="fas fa-sync-alt me-2"></i>Actualizar
        </button>
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-cog me-2"></i>Acciones Rápidas
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="/tickets/${guild.id}">
                    <i class="fas fa-ticket-alt me-2"></i>Ver Tickets
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="openQuickModerationModal()">
                    <i class="fas fa-shield-alt me-2"></i>Moderación Rápida
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="openMusicControlModal()">
                    <i class="fas fa-music me-2"></i>Control de Música
                </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Estadísticas principales -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-number" id="memberCount">${guild.memberCount}</div>
            <div class="stats-label">
                <i class="fas fa-users me-1"></i>
                Miembros Totales
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-number" id="onlineMembers">-</div>
            <div class="stats-label">
                <i class="fas fa-circle text-success me-1"></i>
                Miembros Online
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-number" id="activeTickets">-</div>
            <div class="stats-label">
                <i class="fas fa-ticket-alt me-1"></i>
                Tickets Activos
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-number" id="todayMessages">-</div>
            <div class="stats-label">
                <i class="fas fa-comments me-1"></i>
                Mensajes Hoy
            </div>
        </div>
    </div>
</div>

<!-- Funciones principales -->
<div class="row g-4 mb-4">
    <!-- Moderación -->
    <div class="col-md-6 col-lg-4">
        <div class="card h-100 function-card" data-function="moderation">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Moderación
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Gestiona miembros, roles y permisos del servidor</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-sm" onclick="openModerationPanel()">
                        <i class="fas fa-cog me-1"></i>Panel de Moderación
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="viewModerationLogs()">
                        <i class="fas fa-list me-1"></i>Ver Logs
                    </button>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Últimas acciones:</small>
                    <div id="recentModerationActions" class="mt-2">
                        <div class="d-flex justify-content-between">
                            <span class="small">Kick usuario</span>
                            <span class="small text-muted">Hace 2h</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tickets -->
    <div class="col-md-6 col-lg-4">
        <div class="card h-100 function-card" data-function="tickets">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-ticket-alt me-2"></i>
                    Sistema de Tickets
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Gestiona tickets de soporte en tiempo real</p>
                <div class="d-grid gap-2">
                    <a href="/tickets/${guild.id}" class="btn btn-primary btn-sm">
                        <i class="fas fa-eye me-1"></i>Dashboard de Tickets
                    </a>
                    <button class="btn btn-outline-primary btn-sm" onclick="createTicketManually()">
                        <i class="fas fa-plus me-1"></i>Crear Ticket
                    </button>
                </div>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="fw-bold text-success" id="openTicketsCount">-</div>
                            <small class="text-muted">Abiertos</small>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold text-secondary" id="closedTicketsCount">-</div>
                            <small class="text-muted">Cerrados</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Música -->
    <div class="col-md-6 col-lg-4">
        <div class="card h-100 function-card" data-function="music">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-music me-2"></i>
                    Sistema de Música
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Controla la reproducción de música del bot</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-sm" onclick="openMusicPanel()">
                        <i class="fas fa-play me-1"></i>Panel de Música
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="viewMusicQueue()">
                        <i class="fas fa-list me-1"></i>Ver Cola
                    </button>
                </div>
                <div class="mt-3">
                    <div class="music-status" id="musicStatus">
                        <small class="text-muted">Estado: <span class="text-secondary">Desconectado</span></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Niveles y XP -->
    <div class="col-md-6 col-lg-4">
        <div class="card h-100 function-card" data-function="levels">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>
                    Sistema de Niveles
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Gestiona XP, niveles y recompensas</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-sm" onclick="openLevelsPanel()">
                        <i class="fas fa-chart-bar me-1"></i>Panel de Niveles
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="viewLeaderboard()">
                        <i class="fas fa-medal me-1"></i>Leaderboard
                    </button>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Top usuario:</small>
                    <div class="d-flex justify-content-between mt-1">
                        <span class="small fw-bold" id="topUser">Cargando...</span>
                        <span class="small text-primary" id="topUserLevel">Lv. -</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sorteos -->
    <div class="col-md-6 col-lg-4">
        <div class="card h-100 function-card" data-function="giveaways">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-gift me-2"></i>
                    Sorteos
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Crea y gestiona sorteos automáticos</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-sm" onclick="createGiveaway()">
                        <i class="fas fa-plus me-1"></i>Crear Sorteo
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="viewActiveGiveaways()">
                        <i class="fas fa-list me-1"></i>Sorteos Activos
                    </button>
                </div>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="fw-bold text-warning" id="activeGiveaways">-</div>
                            <small class="text-muted">Activos</small>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold text-success" id="completedGiveaways">-</div>
                            <small class="text-muted">Completados</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TempVoice -->
    <div class="col-md-6 col-lg-4">
        <div class="card h-100 function-card" data-function="tempvoice">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-microphone me-2"></i>
                    TempVoice
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Canales de voz temporales automáticos</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-sm" onclick="openTempVoicePanel()">
                        <i class="fas fa-cog me-1"></i>Configurar TempVoice
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="viewTempVoiceStats()">
                        <i class="fas fa-chart-line me-1"></i>Estadísticas
                    </button>
                </div>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="fw-bold text-info" id="activeTempChannels">-</div>
                            <small class="text-muted">Canales Activos</small>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold text-primary" id="tempChannelsToday">-</div>
                            <small class="text-muted">Creados Hoy</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Actividad reciente y gráficos -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Actividad del Servidor
                </h5>
            </div>
            <div class="card-body">
                <canvas id="activityChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bell me-2"></i>
                    Actividad Reciente
                </h5>
            </div>
            <div class="card-body">
                <div id="recentActivity">
                    <div class="activity-item d-flex align-items-center mb-3">
                        <div class="activity-icon bg-success text-white rounded-circle me-3">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">Nuevo miembro</div>
                            <small class="text-muted">Usuario#1234 se unió</small>
                        </div>
                        <small class="text-muted">Hace 5m</small>
                    </div>
                    
                    <div class="activity-item d-flex align-items-center mb-3">
                        <div class="activity-icon bg-primary text-white rounded-circle me-3">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">Ticket creado</div>
                            <small class="text-muted">Ticket de soporte #001</small>
                        </div>
                        <small class="text-muted">Hace 12m</small>
                    </div>
                    
                    <div class="activity-item d-flex align-items-center mb-3">
                        <div class="activity-icon bg-warning text-white rounded-circle me-3">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">Acción de moderación</div>
                            <small class="text-muted">Usuario advertido</small>
                        </div>
                        <small class="text-muted">Hace 1h</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .function-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
    }
    
    .function-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-xl);
        border-color: var(--primary-color);
    }
    
    .activity-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
    }
    
    .guild-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .stats-card {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white !important;
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        text-align: center;
    }
    
    .stats-number {
        font-size: 2rem;
        font-weight: bold;
        color: white !important;
        margin-bottom: 0.5rem;
    }
    
    .stats-label {
        color: rgba(255, 255, 255, 0.9) !important;
        font-size: 0.875rem;
    }
    
    .card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
    }
    
    .card-header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
    }
</style>
`, script: `
<script>
    // Cargar datos del servidor
    async function loadGuildData() {
        try {
            const response = await fetch('/api/guild/${guild.id}/info');
            if (response.ok) {
                const data = await response.json();
                
                // Actualizar estadísticas
                document.getElementById('memberCount').textContent = data.memberCount.toLocaleString();
                document.getElementById('onlineMembers').textContent = Math.floor(data.memberCount * 0.3); // Simulado
                
                // Cargar datos específicos de cada función
                loadTicketStats();
                loadMusicStatus();
                loadLevelStats();
                loadGiveawayStats();
                loadTempVoiceStats();
            }
        } catch (error) {
            console.error('Error cargando datos del servidor:', error);
        }
    }

    // Cargar estadísticas de tickets
    async function loadTicketStats() {
        try {
            const response = await fetch('/tickets/${guild.id}/stats');
            if (response.ok) {
                const stats = await response.json();
                document.getElementById('activeTickets').textContent = stats.open || 0;
                document.getElementById('openTicketsCount').textContent = stats.open || 0;
                document.getElementById('closedTicketsCount').textContent = stats.closed || 0;
            }
        } catch (error) {
            console.error('Error cargando estadísticas de tickets:', error);
        }
    }

    // Cargar estado de música
    function loadMusicStatus() {
        // Simulado - se conectaría con discord-player
        document.getElementById('musicStatus').innerHTML = 
            '<small class="text-muted">Estado: <span class="text-success">Conectado</span></small>';
    }

    // Cargar estadísticas de niveles
    function loadLevelStats() {
        // Simulado - se conectaría con la base de datos
        document.getElementById('topUser').textContent = 'Usuario#1234';
        document.getElementById('topUserLevel').textContent = 'Lv. 25';
    }

    // Cargar estadísticas de sorteos
    function loadGiveawayStats() {
        // Simulado
        document.getElementById('activeGiveaways').textContent = '2';
        document.getElementById('completedGiveaways').textContent = '15';
    }

    // Cargar estadísticas de TempVoice
    function loadTempVoiceStats() {
        // Simulado
        document.getElementById('activeTempChannels').textContent = '3';
        document.getElementById('tempChannelsToday').textContent = '12';
    }

    // Crear gráfico de actividad
    function createActivityChart() {
        const ctx = document.getElementById('activityChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                datasets: [{
                    label: 'Mensajes',
                    data: [120, 190, 300, 500, 200, 300, 450],
                    borderColor: 'var(--primary-color)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Miembros Activos',
                    data: [80, 120, 180, 250, 150, 200, 280],
                    borderColor: 'var(--secondary-color)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'var(--border-color)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'var(--border-color)'
                        }
                    }
                }
            }
        });
    }

    // Funciones de los paneles
    function openModerationPanel() {
        window.location.href = '/guild/${guild.id}/moderation';
    }

    function openMusicPanel() {
        window.location.href = '/guild/${guild.id}/music';
    }

    function openLevelsPanel() {
        window.location.href = '/guild/${guild.id}/levels';
    }

    function openTempVoicePanel() {
        window.location.href = '/guild/${guild.id}/tempvoice';
    }

    function createGiveaway() {
        // Abrir modal de crear sorteo
        showNotification('Función de sorteos en desarrollo', 'info');
    }

    function createTicketManually() {
        // Abrir modal de crear ticket
        showNotification('Función de crear ticket manual en desarrollo', 'info');
    }

    // Función de actualizar datos
    function refreshData() {
        loadGuildData();
        showNotification('Datos actualizados', 'success');
    }

    // Inicializar dashboard
    document.addEventListener('DOMContentLoaded', function() {
        loadGuildData();
        createActivityChart();
        
        // Actualizar cada 30 segundos
        setInterval(loadGuildData, 30000);
    });

    // Socket.IO para actualizaciones en tiempo real
    socket.on('guild-update', (data) => {
        if (data.guildId === '${guild.id}') {
            loadGuildData();
        }
    });
</script>
` }) %>
