<%- include('../layout', { title: 'Configuración - ' + guild.name, body: `
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">
            <i class="fas fa-cog me-2"></i>
            Configuración del Servidor
        </h1>
        <p class="text-muted mb-0">${guild.name}</p>
    </div>
    <a href="/guild/${guild.id}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Volver
    </a>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <img id="guildIcon" src="${guild.iconURL || ''}" class="rounded mb-3" width="80" onerror="this.style.display='none'">
                <h5 id="guildName">${guild.name}</h5>
                <p class="text-muted mb-0" id="guildOwner">Propietario: -</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h6>Miembros</h6>
                <h3 id="guildMembers">-</h3>
                <p class="text-muted mb-0">Canales: <span id="guildChannels">-</span></p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h6>Boost Level</h6>
                <h3 id="guildBoost">-</h3>
                <p class="text-muted mb-0">Boosts: <span id="guildBoostCount">-</span></p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-palette me-2"></i>
                    Apariencia del panel
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="accentColorPicker" class="form-label">Color principal del tema</label>
                    <input type="color" id="accentColorPicker" class="form-control form-control-color" value="#5865f2" title="Elige el color principal del panel">
                    <div class="form-text">Este ajuste solo afecta a tu panel actual (se guarda en este navegador).</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-robot me-2"></i>
                    ChatGPT por canal
                </h5>
                <small class="text-muted">Controla en qué canales responde la IA</small>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    Desde aquí puedes pausar o activar las respuestas automáticas de ChatGPT por canal.
                    Es equivalente a usar el comando <code>/gpt-toggle</code> dentro de cada canal.
                </p>
                <div id="gptChannelsContainer">
                    <div class="text-center text-muted py-3">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        Cargando canales...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bullhorn me-2"></i>
                    Enviar mensaje de prueba
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Canal de texto</label>
                        <select id="testChannel" class="form-select">
                            <option value="">Cargando canales...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Mensaje</label>
                        <input type="text" id="testMessage" class="form-control" placeholder="Mensaje de prueba desde el dashboard">
                    </div>
                    <div class="col-md-2 text-end">
                        <button class="btn btn-primary w-100" onclick="sendTestMessage()">
                            <i class="fas fa-paper-plane me-1"></i>Enviar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
`, script: `
<script>
    const guildId = '${guild.id}';

    async function loadGuildInfo() {
        try {
            const res = await fetch('/api/guild/' + guildId + '/info');
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const info = await res.json();

            document.getElementById('guildName').textContent = info.name;
            document.getElementById('guildMembers').textContent = info.memberCount;
            document.getElementById('guildChannels').textContent = info.channels.total;
            document.getElementById('guildBoost').textContent = 'Nivel ' + info.boostLevel;
            document.getElementById('guildBoostCount').textContent = info.boostCount;
            if (info.owner) {
                document.getElementById('guildOwner').textContent = 'Propietario: ' + info.owner.user.tag;
            }
        } catch (e) {
            console.error('Error cargando info de servidor:', e);
        }
    }

    async function loadChannels() {
        try {
            const res = await fetch('/api/guild/' + guildId + '/channels');
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const channels = await res.json();

            const select = document.getElementById('testChannel');
            const textChannels = channels.filter(c => c.type === 0);
            if (textChannels.length === 0) {
                select.innerHTML = '<option value="">No hay canales de texto</option>';
                return;
            }

            select.innerHTML = textChannels
                .sort((a, b) => a.position - b.position)
                .map(c => '<option value="' + c.id + '">#' + c.name + '</option>')
                .join('');
        } catch (e) {
            console.error('Error cargando canales:', e);
        }
    }

    async function loadGPTChannels() {
        const container = document.getElementById('gptChannelsContainer');
        if (!container) return;

        try {
            const res = await fetch('/api/guild/' + guildId + '/gpt-channels');
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const channels = await res.json();

            if (!channels || channels.length === 0) {
                container.innerHTML = '<p class="text-muted mb-0">No se encontraron canales de texto en este servidor.</p>';
                return;
            }

            const rows = channels.map(c => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>#${c.name}</strong>
                    </div>
                    <div class="form-check form-switch mb-0">
                        <input class="form-check-input" type="checkbox" id="gpt-channel-${c.id}" ${c.paused ? '' : 'checked'} onclick="toggleGPTChannel('${c.id}', this.checked)">
                        <label class="form-check-label small" for="gpt-channel-${c.id}">
                            ${c.paused ? 'Pausado' : 'Activo'}
                        </label>
                    </div>
                </div>
            `).join('');

            container.innerHTML = rows;
        } catch (e) {
            console.error('Error cargando canales GPT:', e);
            container.innerHTML = '<p class="text-danger mb-0">Error cargando canales para ChatGPT.</p>';
        }
    }

    async function toggleGPTChannel(channelId, active) {
        try {
            const res = await fetch('/api/guild/' + guildId + '/gpt-channels/' + channelId, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paused: !active })
            });

            const data = await res.json();

            if (!res.ok || !data.success) {
                showNotification('Error al actualizar ChatGPT en el canal seleccionado', 'danger');
                // Revertir visualmente el cambio si falla
                const checkbox = document.getElementById('gpt-channel-' + channelId);
                if (checkbox) {
                    checkbox.checked = !active;
                }
                return;
            }

            const checkbox = document.getElementById('gpt-channel-' + channelId);
            const label = checkbox ? checkbox.nextElementSibling : null;
            if (label) {
                label.textContent = data.paused ? 'Pausado' : 'Activo';
            }

            if (data.paused) {
                showNotification('ChatGPT ha sido pausado en el canal seleccionado.', 'warning');
            } else {
                showNotification('ChatGPT ha sido activado en el canal seleccionado.', 'success');
            }
        } catch (e) {
            console.error('Error actualizando canal GPT:', e);
            showNotification('Error interno al actualizar ChatGPT en el canal.', 'danger');
        }
    }

    async function sendTestMessage() {
        const channelId = document.getElementById('testChannel').value;
        const content = document.getElementById('testMessage').value || 'Mensaje de prueba desde el panel Zeus System';

        if (!channelId) {
            showNotification('Selecciona un canal de texto', 'warning');
            return;
        }

        try {
            const res = await fetch('/api/guild/' + guildId + '/channel/' + channelId + '/message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });

            const data = await res.json();
            if (res.ok) {
                showNotification('Mensaje enviado a #' + data.channel, 'success');
            } else {
                showNotification('Error: ' + (data.error || 'No se pudo enviar el mensaje'), 'danger');
            }
        } catch (e) {
            console.error('Error enviando mensaje:', e);
            showNotification('Error interno al enviar mensaje', 'danger');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadGuildInfo();
        loadChannels();
        loadGPTChannels();
    });
</script>
` }) %>
