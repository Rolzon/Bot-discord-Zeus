<%- include('../layout', { title: 'Configuración - ' + guild.name, body: `
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">
            <i class="fas fa-cog me-2"></i>
            Configuración del Servidor
        </h1>
        <p class="text-muted mb-0">${guild.name}</p>
    </div>
    <a href="/guild/${guild.id}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Volver
    </a>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <img id="guildIcon" src="${guild.iconURL || ''}" class="rounded mb-3" width="80" onerror="this.style.display='none'">
                <h5 id="guildName">${guild.name}</h5>
                <p class="text-muted mb-0" id="guildOwner">Propietario: -</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h6>Miembros</h6>
                <h3 id="guildMembers">-</h3>
                <p class="text-muted mb-0">Canales: <span id="guildChannels">-</span></p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h6>Boost Level</h6>
                <h3 id="guildBoost">-</h3>
                <p class="text-muted mb-0">Boosts: <span id="guildBoostCount">-</span></p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-palette me-2"></i>
                    Apariencia del panel
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="accentColorPicker" class="form-label">Color principal del tema</label>
                    <input type="color" id="accentColorPicker" class="form-control form-control-color" value="#5865f2" title="Elige el color principal del panel">
                    <div class="form-text">Este ajuste solo afecta a tu panel actual (se guarda en este navegador).</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-robot me-2"></i>
                    Configuración de ChatGPT
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="gptIgnoreRoleSelect" class="form-label">Rol que prioriza respuestas humanas</label>
                    <select id="gptIgnoreRoleSelect" class="form-select">
                        <option value="">Cargando roles...</option>
                    </select>
                    <div class="form-text">Si el usuario con este rol responde a otra persona, el bot esperará antes de responder con IA.</div>
                </div>
                <div class="mb-3">
                    <label for="gptPendingTimeout" class="form-label">Tiempo de espera antes de responder (minutos)</label>
                    <input type="number" id="gptPendingTimeout" class="form-control" min="1" step="1" value="5">
                    <div class="form-text">Si nadie responde en este tiempo, el bot contestará automáticamente con ChatGPT.</div>
                </div>
                <div class="text-end">
                    <button class="btn btn-primary" onclick="saveGPTConfig()">
                        <i class="fas fa-save me-1"></i>Guardar configuración
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bullhorn me-2"></i>
                    Enviar mensaje de prueba
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Canal de texto</label>
                        <select id="testChannel" class="form-select">
                            <option value="">Cargando canales...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Mensaje</label>
                        <input type="text" id="testMessage" class="form-control" placeholder="Mensaje de prueba desde el dashboard">
                    </div>
                    <div class="col-md-2 text-end">
                        <button class="btn btn-primary w-100" onclick="sendTestMessage()">
                            <i class="fas fa-paper-plane me-1"></i>Enviar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
`, script: `
<script>
    const guildId = '${guild.id}';

    async function loadGuildInfo() {
        try {
            const res = await fetch('/api/guild/' + guildId + '/info');
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const info = await res.json();

            document.getElementById('guildName').textContent = info.name;
            document.getElementById('guildMembers').textContent = info.memberCount;
            document.getElementById('guildChannels').textContent = info.channels.total;
            document.getElementById('guildBoost').textContent = 'Nivel ' + info.boostLevel;
            document.getElementById('guildBoostCount').textContent = info.boostCount;
            if (info.owner) {
                document.getElementById('guildOwner').textContent = 'Propietario: ' + info.owner.user.tag;
            }
        } catch (e) {
            console.error('Error cargando info de servidor:', e);
        }
    }

    async function loadChannels() {
        try {
            const res = await fetch('/api/guild/' + guildId + '/channels');
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const channels = await res.json();

            const select = document.getElementById('testChannel');
            const textChannels = channels.filter(c => c.type === 0);
            if (textChannels.length === 0) {
                select.innerHTML = '<option value="">No hay canales de texto</option>';
                return;
            }

            select.innerHTML = textChannels
                .sort((a, b) => a.position - b.position)
                .map(c => '<option value="' + c.id + '">#' + c.name + '</option>')
                .join('');
        } catch (e) {
            console.error('Error cargando canales:', e);
        }
    }

    async function loadRoles() {
        try {
            const res = await fetch('/api/guild/' + guildId + '/roles');
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const roles = await res.json();

            const select = document.getElementById('gptIgnoreRoleSelect');
            if (!select) return;

            const manageableRoles = roles.filter(r => !r.managed);

            if (manageableRoles.length === 0) {
                select.innerHTML = '<option value="">No hay roles disponibles</option>';
                return;
            }

            select.innerHTML = '<option value="">(Sin rol específico)</option>' +
                manageableRoles
                    .map(r => '<option value="' + r.id + '">' + r.name + '</option>')
                    .join('');
        } catch (e) {
            console.error('Error cargando roles:', e);
        }
    }

    async function loadGPTConfig() {
        try {
            const res = await fetch('/api/guild/' + guildId + '/gpt-config');
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const config = await res.json();

            const roleSelect = document.getElementById('gptIgnoreRoleSelect');
            const timeoutInput = document.getElementById('gptPendingTimeout');

            if (roleSelect && typeof config.ignoreRoleId !== 'undefined') {
                roleSelect.value = config.ignoreRoleId || '';
            }

            if (timeoutInput && typeof config.pendingTimeoutMinutes !== 'undefined') {
                timeoutInput.value = config.pendingTimeoutMinutes;
            }
        } catch (e) {
            console.error('Error cargando configuración de GPT:', e);
        }
    }

    async function saveGPTConfig() {
        const roleSelect = document.getElementById('gptIgnoreRoleSelect');
        const timeoutInput = document.getElementById('gptPendingTimeout');

        const ignoreRoleId = roleSelect ? roleSelect.value || null : null;
        const pendingTimeoutMinutes = timeoutInput ? parseInt(timeoutInput.value) || 5 : 5;

        try {
            const res = await fetch('/api/guild/' + guildId + '/gpt-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ignoreRoleId, pendingTimeoutMinutes })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                showNotification('Configuración de ChatGPT guardada correctamente', 'success');
            } else {
                showNotification('Error: ' + (data.error || 'No se pudo guardar la configuración de ChatGPT'), 'danger');
            }
        } catch (e) {
            console.error('Error guardando configuración de GPT:', e);
            showNotification('Error interno al guardar configuración de ChatGPT', 'danger');
        }
    }

    async function sendTestMessage() {
        const channelId = document.getElementById('testChannel').value;
        const content = document.getElementById('testMessage').value || 'Mensaje de prueba desde el panel Zeus System';

        if (!channelId) {
            showNotification('Selecciona un canal de texto', 'warning');
            return;
        }

        try {
            const res = await fetch('/api/guild/' + guildId + '/channel/' + channelId + '/message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });

            const data = await res.json();
            if (res.ok) {
                showNotification('Mensaje enviado a #' + data.channel, 'success');
            } else {
                showNotification('Error: ' + (data.error || 'No se pudo enviar el mensaje'), 'danger');
            }
        } catch (e) {
            console.error('Error enviando mensaje:', e);
            showNotification('Error interno al enviar mensaje', 'danger');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadGuildInfo();
        loadChannels();
        loadRoles();
        loadGPTConfig();
    });
</script>
` }) %>
